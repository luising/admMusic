<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>adms</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
    <script src="js/jquery-1.6.3.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="css/table_request.css">
  </head>
  <body>

    <!-- tables -->
    <div class="wrapper">
      <h1>Solicitudes</h1>
      <div id="tableRequest" class="table">
        <div class="row header blue">
          <div class="cell"> Codigo </div>
          <div class="cell"> Cliente </div>
          <div class="cell"> Telefono </div>
          <div class="cell"> Fecha </div>
          <div class="cell"> Servicio </div>
        </div>
      </div>
      <h1>Eventos Aceptados</h1>
      <div id="tableEvent" class="table">
        <div class="row header green">
          <div class="cell"> Codigo </div>
          <div class="cell"> Cliente </div>
          <div class="cell"> Telefono </div>
          <div class="cell"> Fecha </div>
          <div class="cell"> Servicio </div>
          <div class="cell"> Costo </div>
        </div>
      </div>
      <h1>Eventos Rechazados</h1>
      <div id="tableCancel" class="table">
        <div class="row header">
          <div class="cell"> Codigo </div>
          <div class="cell"> Cliente </div>
          <div class="cell"> Telefono </div>
          <div class="cell"> Fecha </div>
          <div class="cell"> Servicio </div>
        </div>
      </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="myModal" role="dialog">
      <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">Datos del Cliente</h4>
          </div>
          <div class="modal-body">
            <div id="map"></div>
          </div>
          <div class="modal-footer">
            <button type="button" id="btnAcept" class="btn btn-default" data-dismiss="modal">Aceptar</button>
            <button type="button" id="btnR" class="btn btn-default" data-dismiss="modal">Rechazar</button>
            <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
          </div>
        </div>
      </div>
    </div>
    <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script src="https://www.gstatic.com/firebasejs/4.6.0/firebase.js"></script>
    <script src="js/firebase.js" type="text/javascript"></script>
    <!-- javascript logica -->
    <!-- carga de datos -->
    <script type="text/javascript">
      function getData()
      {
        var listRequest = [];
        var listCancel = [];
        var listEvent = [];
        db.once('value', function(snapshot){
          Clientdb = snapshot.child("Client");
          Servicedb = snapshot.child("Service");
          Requestdb = snapshot.child("Request");
          Eventdb = snapshot.child("Event");
          // solicitudes
          Requestdb.forEach(function(child){
            Request = child.val();
            // pendiente
            if(Request.isAcept == 0){
              Client = Clientdb.child(Request.ClientId).val();
              Service = Servicedb.child(Request.ServiceId).val();
              listRequest.push({
                codigo:child.key,
                Nombre:Client.Name,
                Phone:Client.Phone,
                Fecha:Service.Date,
                Servicio:Service.Time + "h",
              });
            }else if(Request.isAcept == -1){
              if(Request.isAdv == 0){
                // Rechazadas
                Client = Clientdb.child(Request.ClientId).val();
                Service = Servicedb.child(Request.ServiceId).val();
                listCancel.push({
                  codigo:child.key,
                  Nombre:Client.Name,
                  Phone:Client.Phone,
                  Fecha:Service.Date,
                  Servicio:Service.Time + "h",
                });
              }
            }
          });
          // eventos
          Eventdb.forEach(function(child){
            currentEvent = child.val();
            if(currentEvent.isAdv == 0){
              Client = Clientdb.child(currentEvent.ClientId).val();
              Service = Servicedb.child(currentEvent.ServiceId).val();
              listEvent.push({
                codigo:child.key,
                Nombre:Client.Name,
                Telefono:Client.Phone,
                Fecha:Service.Date,
                Servicio:Service.Time + "h",
                Costo:Service.Cost
              });
            }
          });
          getRows(listRequest, "tableRequest");
          getRows(listCancel, "tableCancel", 1, 0);
          getRows(listEvent, "tableEvent", 1, 1);
        });
      }
      function getRows(data, table, menu, isAcept)
      {
        for (var i in data){
          var html = '<div data-toggle="modal" data-target="#myModal" class="row">';
          $.each(data[i], function(key, value) {
            html += '<div class="cell">' + value + '</div>';
          });
          if(menu == 1){
            phone = data[i].Telefono;
            if(isAcept == 1){
              titulo = "notificar aceptado";
              mensage = "hola " + data[i].Nombre + ", su solicitud fue aceptada para " + data[i].Fecha +"\n Costo : " + data[i].Costo;
              c = "green";
            }else{
              titulo = "notificar Rechazado";
              mensage = "hola " + data[i].Nombre + ", los sentimos su solicitud fue Rechazada para " + data[i].Fecha;
              c = "red";
            }
            etiqueta = '<a color=' + c + ' href="https://api.whatsapp.com/send?text=' + mensage + '&phone=52'+ phone + '">' + titulo + '</a>';
            html += '<div class="cell">' + etiqueta + '</div>';
          }
          html += '</div>';
          $("#" + table).append(html);
          if(menu != 1){
            addRowHandlers();
          }
        }
      }
      var keyactual;
      function getRequestModal(key)
      {
        keyactual = key;
        db.once('value', function(snapshot){
          $(".modalinfo").remove();
          Clientdb = snapshot.child("Client");
          Servicedb = snapshot.child("Service");
          Requestdb = snapshot.child("Request");
          Eventdb = snapshot.child("Event");

          Request = Requestdb.child(key).val();
          Client = Clientdb.child(Request.ClientId).val();
          Service = Servicedb.child(Request.ServiceId).val();
          en = "<div class='modalinfo'>"
          linea1 = "<p><strong>codigo:" + key + "</strong></p>";
          linea2 = "<strong>Nombre:</strong>" + Client.Name +" &nbsp &nbsp <strong>Telefono:</strong>"+ Client.Phone +"<br />";
          linea3 = "<strong>Ubicacion:</strong>" + Client.Dress + " &nbsp &nbsp <strong>Servicio:</strong>" + Service.Time + " h<br />";
          fin = "</div>"

          $(".modal-body").append(en + linea1 + linea2 + linea3 + fin);
        });
      }
      function addRowHandlers()
      {
        $(function() {
            $("div.row").on("click", function(e){
              var Requestid = $(this).find('.cell:first-child').text();
              getRequestModal(Requestid);
              e.preventDefault();
            });
        });
      }
      getData();
    </script>
    <!-- evento de botones -->
    <script type="text/javascript">
      $( "#btnAcept" ).click(function() {
        var cost = prompt("intruduce el costo del Evento");
        if (cost == null || cost == "" || !/^([0-9])*$/.test(cost)) {
          alert("por favor introdusca un valor valido");
        } else {
          db.once('value', function(snapshot){
            Request = snapshot.child("Request").child(keyactual).val();
            Request.isAcept = 1;
            Request["isAdv"] = 0;
            console.log(Request);
            db.child("Service").child(Request.ServiceId).update({Cost:cost});
            db.child("Event").child(keyactual).set(Request);
            db.child("Request").child(keyactual).set(Request);
          });

        }

        alert("asignado a Evento");
        // location.reload();
      });
      $( "#btnR" ).click(function() {
        console.log(keyactual);
        db.once('value', function(snapshot){
          Request = snapshot.child("Request").child(keyactual).val();
          Request.isAcept = -1;
          Request["isAdv"] = 0;
          db.child("Request").child(keyactual).set(Request);
        });
        // location.reload();
      });
    </script>
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCQ7UhEG1Mf9aGBuVGqKcTneZBcSphPU0g&callback=initMap">
    </script>
    <script type="text/javascript">
      var map;
      function initMap() {
        var ubi = {lat: -25.363, lng: 131.044};
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 15,
          center: ubi
        });
        var marker = new google.maps.Marker({
          position: ubi,
          map: map
        });
        $('#myModal').on('shown.bs.modal', function () {
          google.maps.event.trigger(map, "resize");
        });
      }
    </script>

  </body>
</html>
